(function(e){function t(t){for(var n,a,r=t[0],c=t[1],l=t[2],h=0,p=[];h<r.length;h++)a=r[h],s[a]&&p.push(s[a][0]),s[a]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(e[n]=c[n]);d&&d(t);while(p.length)p.shift()();return i.push.apply(i,l||[]),o()}function o(){for(var e,t=0;t<i.length;t++){for(var o=i[t],n=!0,r=1;r<o.length;r++){var c=o[r];0!==s[c]&&(n=!1)}n&&(i.splice(t--,1),e=a(a.s=o[0]))}return e}var n={},s={app:0},i=[];function a(t){if(n[t])return n[t].exports;var o=n[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,a),o.l=!0,o.exports}a.m=e,a.c=n,a.d=function(e,t,o){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(a.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(o,n,function(t){return e[t]}.bind(null,n));return o},a.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/cybrtc/";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],c=r.push.bind(r);r.push=t,r=r.slice();for(var l=0;l<r.length;l++)t(r[l]);var d=c;i.push([0,"chunk-vendors"]),o()})({0:function(e,t,o){e.exports=o("56d7")},"034f":function(e,t,o){"use strict";var n=o("64a9"),s=o.n(n);s.a},"56d7":function(e,t,o){"use strict";o.r(t);var n=o("2b0e"),s=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{attrs:{id:"app"}},[o("VideoFrame")],1)},i=[],a=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{attrs:{id:"videos"}},[o("video",{attrs:{id:"localVideo",autoplay:"",muted:"",playsinline:""},domProps:{srcObject:e.localStream,muted:!0}}),o("video",{attrs:{id:"remoteVideo",autoplay:"",playsinline:""},domProps:{srcObject:e.remoteStream}})])},r=[],c={name:"VideoFrame",data:function(){return{room:void 0,clientId:void 0,isStarted:!1,isInitiator:!1,isChannelReady:!1,turnReady:!1,pc:void 0,pcConfig:{iceServers:[]},localStream:void 0,remoteStream:void 0}},methods:{async requestServers(e){return console.log("Retrieved ICE server information."),new Promise(function(t,o){let n=!1;for(let e of this.pcConfig.iceServers)if(e.urls.startsWith("turn:")){n=!0,this.turnReady=!0;break}if(!n){let n=new XMLHttpRequest;n.onreadystatechange=(()=>{if(4===n.readyState&&200===n.status){let e=JSON.parse(n.responseText);for(let t of e.iceServers)t.url.startsWith("turn:")?this.pcConfig.iceServers.push({urls:t.url,username:t.username,credential:t.credential}):t.url.startsWith("stun:")&&this.pcConfig.iceServers.push({urls:t.url});this.turnReady=!0,t(),console.log("Getting TURN server from ",JSON.stringify(this.pcConfig.iceServers))}}),n.onerror=(()=>{o({status:n.status,statusText:n.statusText})}),n.open("GET",e,!0),n.send()}}.bind(this))},sendMessage(e){let t=JSON.stringify({action:"message",message:e,room:this.room});console.log("C->WSS: ",t),this.$socket.send(t)},async onOpen(e){console.log("Signaling channel opened."),this.$socket=e.currentTarget,""!==this.room&&this.$socket.send(JSON.stringify({action:"create or join",room:this.room})),await Promise.all([this.init(),this.requestServers("https://3hs3ekzhqa.execute-api.us-east-1.amazonaws.com/prod/nat?sig=true")])},async onClose(){console.log("CLOSED")},async onMessage(e){let t=JSON.parse(e.data);switch(t.action){case"created":{let e=t.room,o=t.clientId;this.clientId=o,console.log(`${o} Created the room ${e}`),this.isInitiator=!0,void 0!==this.localStream&&this.maybeStart();break}case"full":{let e=t.room;alert("Room "+e+" is full");break}case"join":{let e=t.room,o=t.clientId;console.log(`Another peer ${o} made a request to join room ${e}`),console.log(`This peer is the initiator of room ${e}!`);break}case"joined":{let e=t.room,o=t.clientId;void 0===this.clientId&&(this.clientId=o),console.log(`Peer ${o} joined: ${e}`),this.isChannelReady=!0,o===this.clientId&&this.sendMessage("ready");break}case"message":{let e=t.message;if(console.log("WSS->C: ",JSON.stringify(e)),"ready"===e)await this.maybeStart();else if("bye"===e&&this.isStarted)this.handleRemoteHangup();else switch(e.type){case"offer":this.isInitiator||this.isStarted||await this.maybeStart(),this.pc.setRemoteDescription(new RTCSessionDescription(e)).then(this.doAnswer);break;case"answer":this.isStarted&&this.pc.setRemoteDescription(new RTCSessionDescription(e));break;case"candidate":if(this.isStarted){let t=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.pc.addIceCandidate(t).then(e=>{console.log("adding ice candidate success")}).catch(e=>console.error(e.message))}break}break}}},onError(e){console.log("ERROR",e.data)},async gotStream(e){console.log("Got access to local media"),console.log("Attaching local stream."),this.localStream=e,this.isInitiator&&await this.maybeStart(),console.log("Start signaling")},async maybeStart(){console.log(">>>>>>> maybeStart() ",this.isStarted,this.localStream,this.isChannelReady),!this.isStarted&&void 0!==this.localStream&&this.isChannelReady?(console.log(">>>>>> creating peer connection"),await this.createPeerConnection(),console.log("Adding local stream."),this.pc.addStream(this.localStream),this.isStarted=!0,console.log("isInitiator",this.isInitiator),this.isInitiator&&this.doCall()):(console.log(`Started: ${this.isStarted} channelReady: ${this.isChannelReady} localStream: ${void 0!==this.localStream}`),console.log("not start"))},async createPeerConnection(){try{try{let t={name:"ECDSA",namedCurve:"P-256"},o=await RTCPeerConnection.generateCertificate(t);console.log("ECDSA certificate generated successfully."),this.pcConfig.certificates=[o]}catch(e){console.log("ECDSA certificate generation failed.")}console.log(`Creating RTCPeerConnnection with: ${this.pcConfig}`),this.pc=new RTCPeerConnection(this.pcConfig),this.pc.onicecandidate=this.handleIceCandidate,this.pc.onaddstream=this.handleRemoteStreamAdded,this.pc.onremovestream=this.handleRemoteStreamRemoved,console.log("Created RTCPeerConnnection")}catch(e){console.log("Failed to create PeerConnection, exception: "+e.message),alert("Cannot create RTCPeerConnection object.")}},doCall(){console.log("Sending offer to peer"),this.pc.createOffer().then(this.setLocalAndSendMessage,this.handleCreateOfferError)},doAnswer(){console.log("Sending answer to peer."),this.pc.createAnswer().then(this.setLocalAndSendMessage,this.onCreateSessionDescriptionError)},handleIceCandidate(e){console.log("icecandidate event: ",e),e.candidate?this.sendMessage({type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}):console.log("End of candidates.")},handleRemoteStreamAdded(e){console.log("Remote stream added."),this.remoteStream=e.stream},handleRemoteStreamRemoved(e){console.log("Remote stream removed. Event: ",e)},setLocalAndSendMessage(e){this.pc.setLocalDescription(e),console.log("setLocalAndSendMessage sending message",e),this.sendMessage(e)},handleCreateOfferError(e){console.log("createOffer() error: ",e)},onCreateSessionDescriptionError(e){console.trace("Failed to create session description: "+e.toString())},handleRemoteHangup(){console.log("Session terminated."),this.stop(),console.log("Now I am initiator of this room"),this.isInitiator=!0},stop(){this.isStarted=!1,this.pc.close(),this.pc=null},async init(){try{let t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0});await this.gotStream(t)}catch(e){alert("getUserMedia() error: "+e.name)}}},async mounted(){this.room=prompt("Enter room name:"),console.log("Opening signaling channel."),this.$options.sockets.onopen=this.onOpen,this.$options.sockets.onclose=this.onClose,this.$options.sockets.onmessage=this.onMessage,this.$options.sockets.onerror=this.onError}},l=c,d=o("2877"),h=Object(d["a"])(l,a,r,!1,null,null,null),p=h.exports,m={name:"app",components:{VideoFrame:p}},u=m,g=(o("034f"),Object(d["a"])(u,s,i,!1,null,null,null)),f=g.exports,S=o("b408"),y=o.n(S);n["a"].config.productionTip=!1,n["a"].use(y.a,"wss://gbgeujsgda.execute-api.us-east-1.amazonaws.com/test",{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:3e3}),new n["a"]({render:e=>e(f)}).$mount("#app")},"64a9":function(e,t,o){}});
//# sourceMappingURL=app.7349a0c4.js.map